<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Proyecto</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles2.css">
</head>
<body class="bg-gray-900 text-gray-200 font-sans p-4 md:p-8">

    <button type="button" id="inventory-editor-btn" class="hidden text-sm font-semibold py-2 px-4 rounded-lg border-0
        bg-purple-600 text-white hover:bg-purple-700 cursor-pointer transition-all duration-150 shadow-lg" 
        style="position: fixed; top: 5px; right: 5px; z-index: 10;">
        Editar Inventario Inicial
    </button>
    <div class="max-w-6xl mx-auto">
        
        <section id="root-folder-section" class="mb-12">
             
            <button type="button" id="select-root-btn" class="   text-lg font-semibold   file:mr-4 py-3 px-5 rounded-lg border-0
                bg-blue-600 text-white hover:bg-blue-700 cursor-pointer transition-all duration-150 shadow-lg" style="position: fixed; top: 5px; left: 5px;" >
                Seleccionar Carpeta Ra√≠z del Proyecto
            </button>
            <p id="folder-status" class="text-gray-500 text-sm mt-2" style="display: none;"  ></p>
        </section>

        <div id="main-editor-container" class="hidden space-y-12">

            <section id="json-editor-section">
                 
                
                <div class="mb-4 border-b border-gray-700">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button type="button" id="tab-terrain" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-cyan-500 text-cyan-400" aria-selected="true">
                            Terrenos
                        </button>
                        <button type="button" id="tab-entity" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            Entidades
                        </button>
                        <button type="button" id="tab-biome" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            Biomas
                        </button>
                        <button type="button" id="tab-items" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            Objetos
                        </button>
                        <button type="button" id="tab-crafting" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            Crafteos
                        </button>
                        <button type="button" id="tab-assets" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            Galeria
                        </button>
                        <button type="button" id="tab-ia" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            ‚ö° IA REALISTA
                        </button>
                  
                        <button type="button" id="tab-ia3d" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            ‚ö° IA SVG y 3D 
                        </button>
                      
                        <button type="button" id="tab-editor3d" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" aria-selected="false">
                            üì¶ Editor 3D
                        </button>
                    </nav>
                </div>

                <div id="tab-content-terrain" class="tab-content">
                    <div id="json-editor-container-terrain" class="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6">
                        <div class="flex justify-between items-center gap-3 mb-4">
                            <h3 class="text-lg font-semibold text-gray-300">Editando Terreno (Galer√≠a)</h3>
                            <div class="flex gap-3">
                                <button type="button" id="add-new-terrain-item-btn" class="json-editor-btn bg-blue-600 hover:bg-blue-700">
                                    + A√±adir Nuevo
                                </button>
                                <button type="button" id="save-terrain-btn" class="json-editor-btn bg-green-600 hover:bg-green-700">
                                    Guardar Cambios
                                </button>
                            </div>
                        </div>
                        <div id="gallery-container-terrain" class="gallery-container">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                </div>

                <div id="tab-content-entity" class="tab-content hidden">
                    <div id="json-editor-container-entity" class="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6">
                         <div class="flex justify-between items-center gap-3 mb-4">
                            <h3 class="text-lg font-semibold text-gray-300">Editando Entidades (Galer√≠a)</h3>
                            <div class="flex gap-3">
                                <button type="button" id="add-new-entity-item-btn" class="json-editor-btn bg-blue-600 hover:bg-blue-700">
                                    + A√±adir Nuevo
                                </button>
                                <button type="button" id="save-entity-btn" class="json-editor-btn bg-green-600 hover:bg-green-700">
                                    Guardar Cambios
                                </button>
                            </div>
                        </div>
                        <div id="gallery-container-entity" class="gallery-container">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                </div>

                <div id="tab-content-biome" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6 space-y-8">
                        <div>
                            <div class="flex justify-between items-center gap-3 mb-4">
                                <h3 class="text-lg font-semibold text-gray-300">Frecuencia de Biomas (BIOME_WEIGHTS)</h3>
                            </div>
                            <div id="biome-weights-list" class="json-raw-editor-container">
                                <p class="text-gray-500">Cargando pesos...</p>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center gap-3 mb-4">
                                <h3 class="text-lg font-semibold text-gray-300">Definiciones de Biomas (Galer√≠a)</h3>
                                <div class="flex gap-3">
                                    <button type="button" id="add-new-biome-item-btn" class="json-editor-btn bg-blue-600 hover:bg-blue-700">
                                        + A√±adir Nuevo
                                    </button>
                                    <button type="button" id="save-biome-btn" class="json-editor-btn bg-green-600 hover:bg-green-700">
                                        Guardar Cambios
                                    </button>
                                </div>
                            </div>
                            <div id="gallery-container-biome" class="gallery-container">
                                <p class="text-gray-500">Cargando biomas...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tab-content-items" class="tab-content hidden">
                    <div id="json-editor-container-items" class="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6">
                         <div class="flex justify-between items-center gap-3 mb-4">
                            <h3 class="text-lg font-semibold text-gray-300">Editando Items (Galer√≠a)</h3>
                            <div class="flex gap-3">
                                <button type="button" id="add-new-item-btn" class="json-editor-btn bg-blue-600 hover:bg-blue-700">
                                    + A√±adir Nuevo
                                </button>
                                <button type="button" id="save-items-btn" class="json-editor-btn bg-green-600 hover:bg-green-700">
                                    Guardar Cambios
                                </button>
                            </div>
                        </div>
                        <div id="gallery-container-items" class="gallery-container">
                            <p class="text-gray-500">Cargando items...</p>
                        </div>
                    </div>
                </div>
                
                <div id="tab-content-crafting" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6 space-y-8">
                        <div class="flex justify-between items-center gap-3">
                            <h3 class="text-lg font-semibold text-gray-300">Editando Recetas de Crafteo</h3>
                            <div class="flex-grow"></div> <button type="button" id="add-new-crafting-table-btn" class="json-editor-btn bg-cyan-600 hover:bg-cyan-700">
                                + A√±adir Nueva Mesa
                            </button>
                            <button type="button" id="save-crafting-btn" class="json-editor-btn bg-green-600 hover:bg-green-700">
                                Guardar Todos los Cambios
                            </button>
                        </div>
                        <div id="crafting-editor-container" class="space-y-8">
                            <p class="text-gray-500">Cargando mesas de crafteo...</p>
                        </div>
                    </div>
                </div>

                <!-- --- INICIO: PESTA√ëA DE GALER√çA MODIFICADA --- -->
                <div id="tab-content-assets" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6 space-y-8">
                        <!-- Navegaci√≥n de Sub-pesta√±as -->
                        <div class="mb-4 border-b border-gray-700">
                            <nav class="-mb-px flex space-x-8" aria-label="Asset Tabs">
                                <button type="button" id="asset-tab-btn-png" class="asset-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" aria-selected="true">
                                    Im√°genes (PNG)
                                </button>
                                <button type="button" id="asset-tab-btn-svg" class="asset-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" aria-selected="false">
                                    Vectores (SVG)
                                </button>
                                <button type="button" id="asset-tab-btn-3d" class="asset-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" aria-selected="false">
                                    Modelos (3D)
                                </button>
                            </nav>
                        </div>
            
                        <!-- Contenido Pesta√±a PNG (Contenido Original) -->
                        <div id="asset-tab-content-png" class="asset-tab-content">
                            <section id="game-assets-section">
                                <div class="flex justify-between items-center gap-3 mb-4">
                                    <div>
                                        <h2 class="text-2xl font-semibold text-white mb-3">Assets de Im√°genes (.png)</h2>
                                        <p class="text-gray-400">
                                            Haz clic en una imagen para editarla. Se encuentran en /assets
                                        </p>
                                    </div>
                                    <button type="button" id="upload-new-asset-btn" class="json-editor-btn bg-green-600 hover:bg-green-700 whitespace-nowrap">
                                        Subir PNGs a /assets
                                    </button>
                                </div>
            
                                <div id="asset-grid-container" class="asset-grid-container">
                                    <p class="text-gray-500">Cargando assets...</p>
                                </div>
                            </section>
                        </div>
            
                        <!-- Contenido Pesta√±a SVG -->
                        <div id="asset-tab-content-svg" class="asset-tab-content hidden">
                            <section id="svg-assets-section">
                                <h2 class="text-2xl font-semibold text-white mb-3">Assets Vectoriales (/SVG)</h2>
                                <div id="svg-grid-container" class="asset-grid-container">
                                    <p class="text-gray-500">Cargando assets SVG...</p>
                                </div>
                            </section>
                        </div>
            
                        <!-- Contenido Pesta√±a 3D -->
                        <div id="asset-tab-content-3d" class="asset-tab-content hidden">
                            <section id="3d-assets-section">
                                <h2 class="text-2xl font-semibold text-white mb-3">Modelos 3D (/assets/3d)</h2>
                                <p class="text-gray-400 mb-4">Haz clic y arrastra en una previsualizaci√≥n para rotar el modelo.</p>
                                <div id="3d-grid-container" class="asset-grid-container">
                                    <p class="text-gray-500">Cargando modelos 3D...</p>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- --- FIN: PESTA√ëA DE GALER√çA MODIFICADA --- -->


                <div id="tab-content-ia" class="tab-content hidden">
                    <div id="ia-generator-container" class="bg-gray-800 rounded-lg shadow-xl p-4 md:p-6 space-y-6">
                        <p class="text-gray-500">Cargando UI del generador IA...</p>
                    </div>
                </div>

                <!-- ================== -->
                <!--  NUEVO CONTENEDOR  -->
                <!-- ================== -->
                <div id="tab-content-ia3d" class="tab-content hidden">
                    <!-- El contenido de SVG MAKER/index.html se pega aqu√≠ -->
                    
                    <!-- Contenedor principal -->
                    <div class="container">
                        <div class="main-content">

                            <!-- Encabezado -->
                            <header>
                                <h1>Generador de Dibujos SVG</h1>
                                <p>Crea y mejora arte vectorial 2D y 3D con IA.</p>
                            </header>

                            <!-- Layout de dos columnas -->
                            <div class="layout-container">

                                <!-- Columna de Controles (Izquierda) -->
                                <div class="controls-column">
                                    
                                    <!-- Secci√≥n de API Key -->
                                 

                                    <!-- Secci√≥n de Modelo -->
                                    <div class="card">
                                        <label for="modelSelect" class="label">Modelo de IA (para 2D)</label>
                                        <select id="modelSelect" class="select-field">
                                            <option value="gemini-2.5-flash-lite-preview-09-2025">2.5 Flash Lite</option>
                                            <option value="gemini-2.5-flash-preview-09-2025" selected>2.5 Flash</option>
                                            <option value="gemini-2.5-pro">2.5 Pro</option>
                                        </select>
                                    </div>

                                    <!-- Secci√≥n de Generaci√≥n -->
                                    <div class="card">
                                        <h2 class="card-title">1. Generar Nuevo Dibujo (2D)</h2>
                                        <label for="promptInput" class="label">Prompt Principal</label>
                                        <textarea id="promptInput" rows="3" class="textarea-field" placeholder="Ej: Un astronauta en la luna, estilo minimalista"></textarea>
                                        
                                        <!-- NOTA: El bot√≥n "Generar Realista" se mantiene, -->
                                        <!-- pero generador_main.js lo conectar√° al generadorrealista.js de editorcreador -->
                                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.75rem;">
                                            <button id="generateButton" class="btn btn-primary">
                                                A√±adir a la cola (Generar SVG)
                                            </button>
                                            <button id="generateRealisticButton" class="btn btn-purple">
                                                A√±adir a la cola (Generar Realista)
                                            </button>
                                        </div>
                                    </div>

                                </div>

                                <!-- Columna de Vista Previa (Derecha) -->
                                <div class="preview-column">
                                    <h2 class="card-title">Vista Previa</h2>
                                    
                                    <div id="previewArea">
                                      
                                    </div>

                                    <!-- Mensaje de estado -->
                                    <div id="statusMessage" class="status-message"></div>

                                    <!-- Secci√≥n de Acciones (para 2D) -->
                                    <div id="actionsSection" class="actions-container hidden">
                                        <button id="copySvgButton" class="btn btn-dark">
                                            Copiar SVG
                                        </button>
                                        <button id="donwloadSvgButton" class="btn btn-success">
                                            Descargar
                                        </button>
                                        <button id="deleteShapeButton" class="btn btn-danger">
                                            Eliminar Forma
                                        </button>
                                    </div>

                                    <!-- SECCI√ìN DE CONTROLES 3D -->
                                    <div id="controls3DSection" class="card hidden">
                                        <h3 class="card-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Controles 3D</h3>
                                        <label for="prompt3D" class="label">Prompt de Generaci√≥n/Edici√≥n 3D:</label>
                                        <textarea id="prompt3D" rows="2" class="textarea-field" placeholder="Ej: Hazlo grueso y de color rojo met√°lico"></textarea>
                                        
                                        <div class="actions-3d-buttons">
                                            <button id="generate3DButton" class="btn btn-primary">
                                                Generar Modelo 3D
                                            </button>
                                            <button id="edit3DButton" class="btn btn-secondary">
                                                Editar Modelo 3D
                                            </button>
                                            <button id="copy3DModelButton" class="btn btn-dark">
                                                Copiar GLTF (JSON)
                                            </button>
                                            <button id="download3DModelButton" class="btn btn-purple">
                                                Descargar GLTF
                                            </button>
                                            <button id="exportPlaneliteButton" class="btn btn-success" title="Exportar en el formato simple de 3 claves (geometries, materials, positions)">
                                                Exportar JSON PLANELITE
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Controles Manuales (para 2D) -->
                                    <div id="manualControls" class="card hidden">
                                        <h3 class="card-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Controles Manuales (2D)</h3>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                                            <button class="btn btn-secondary" data-action="zoom-in">Zoom +</button>
                                            <button class="btn btn-secondary" data-action="pan-up">Arriba</button>
                                            <button class="btn btn-secondary" data-action="zoom-out">Zoom -</button>
                                            <button class="btn btn-secondary" data-action="pan-left">Izquierda</button>
                                            <button class="btn btn-secondary" data-action="reset">Reset</button>
                                            <button class="btn btn-secondary" data-action="pan-right">Derecha</button>
                                            <span></span> <button class="btn btn-secondary" data-action="pan-down">Abajo</button>
                                            <span></span> 
                                        </div>
                                    </div>
                                    
                                    <!-- Contenedor del c√≥digo SVG (para 2D) -->
                                    <div id="svgCodeWrapper" class="hidden">
                                        <label class="label">C√≥digo SVG (solo lectura)</label>
                                        <pre id="svgCodeContainer"><code id="svgCode">...</code></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Nueva Secci√≥n de Galer√≠a -->
                            <div id="gallerySection" class="card gallery-container">
                                <div class="gallery-header">
                                    <h2 class="card-title">Mi Galer√≠a (Persistente)</h2>
                                    
                                    <!-- --- ¬°BOTONES MODIFICADOS! --- -->
                                    <div class="flex flex-wrap gap-2">
                                        <input type="file" id="uploadGalleryInput" accept=".json" class="hidden">
                                        <label for="uploadGalleryInput" id="uploadGalleryLabel" class="btn btn-success">
                                            Cargar (JSON)
                                        </label>
                                        <button id="saveGalleryButton" class="btn btn-primary" title="Guardar la galer√≠a actual en ia_gallery.json en la ra√≠z del proyecto">
                                            Guardar en Proyecto
                                        </button>
                                        <button id="downloadGalleryButton" class="btn btn-purple" title="Descargar una copia de la galer√≠a a tu PC">
                                            Descargar Copia (a PC)
                                        </button>
                                    </div>
                                    <!-- --- FIN BOTONES MODIFICADOS --- -->

                                </div>
                                <div id="galleryGrid" class="gallery-grid">
                                    <!-- Los items de la galer√≠a se insertar√°n aqu√≠ -->
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Loader Overlay (Espec√≠fico de este m√≥dulo) -->
                    <div id="loader" class="loader-overlay hidden">
                        <div class="loader-content">
                            <div class="spinner"></div>
                            <p>Procesando...</p>
                        </div>
                    </div>

                    <!-- Modal de Mejora (Espec√≠fico de este m√≥dulo) -->
                    <div id="improveModal" class="modal-overlay hidden">
                        <div class="modal-content card">
                            <h2 class="card-title">Editar Item</h2>
                            
                            <label for="modalItemName" class="label">Nombre:</label>
                            <input type="text" id="modalItemName" class="input-field">

                            <div id="modalImproveSection">
                                <label for="modalImprovePrompt" class="label">Instrucci√≥n de Mejora (2D):</label>
                                <textarea id="modalImprovePrompt" rows="3" class="textarea-field" placeholder="Ej: A√±ade m√°s estrellas y un alien√≠gena"></textarea>
                            </div>

                            <div class="modal-actions">
                                <button id="modalDuplicate" class="btn btn-dark">Duplicar</button>
                                <button id="modalDelete" class="btn btn-danger">Eliminar</button>
                                <button id="modalImproveCancel" class="btn btn-secondary">Cancelar</button>
                                <button id="modalRenameSave" class="btn btn-dark">Solo Guardar Nombre</button>
                                <button id="modalImproveConfirm" class="btn btn-primary">Guardar y Mejorar (2D)</button>
                            </div>

                            <!-- Zona de confirmaci√≥n de borrado -->
                            <div id="modalDeleteConfirm" class="modal-delete-confirm hidden">
                                <p>¬øEst√°s seguro? Esta acci√≥n es irreversible.</p>
                                <button id="modalDeleteConfirmBtn" class="btn btn-danger">S√≠, Eliminar</button>
                                <button id="modalDeleteCancelBtn" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ================== -->
                <!--  FIN NUEVO CONTENEDOR -->
                <!-- ================== -->


                <div id="tab-content-editor3d" class="tab-content hidden">
                    <div class="bg-gray-900 text-white h-[80vh] flex flex-col overflow-hidden">
                        <header class="bg-gray-800 p-3 shadow-lg flex justify-between items-center z-10">
                            <h1 class="text-xl font-bold text-blue-400">Editor de Modelos 3D (JSON) v2.0</h1>
                            <div class="flex items-center space-x-2">
                                <label for="model-select" class="text-sm font-medium">Cargar Preset:</label>
                                <select id="model-select" class="bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="new">-- Nuevo Modelo --</option>
                                    <option value="ferrari">Ferrari (Cajas)</option>
                                    <option value="humanoid_box">Humanoid (Cajas)</option>
                                    <option value="humanoid_real">Humanoid (Real)</option>
                                </select>
                            </div>
                        </header>

                        <div class="flex flex-1 overflow-hidden">
                            
                            <aside class="w-1/3 max-w-sm h-full bg-gray-800 p-4 overflow-y-auto shadow-inner flex flex-col space-y-4">
                                
                                <div id="global-controls-panel" class="bg-gray-700 rounded-lg p-3 space-y-3">
                                    <h2 class="text-lg font-semibold">Transformaci√≥n Global</h2>
                                    
                                    <div class="space-y-2">
                                        <h4 class="text-sm font-medium text-gray-300">Posici√≥n (X, Y, Z)</h4>
                                        <div id="global-position-inputs" class="grid grid-cols-3 gap-2">
                                            </div>

                                        <h4 class="text-sm font-medium text-gray-300">Rotaci√≥n (RX, RY, RZ)</h4>
                                        <div id="global-rotation-inputs" class="grid grid-cols-3 gap-2">
                                            </div>
                                        
                                        <h4 class="text-sm font-medium text-gray-300">Escala (SX, SY, SZ)</h4>
                                        <div id="global-scale-inputs" class="grid grid-cols-3 gap-2">
                                            </div>
                                    </div>

                                    <div class="space-y-2 pt-2 border-t border-gray-600">
                                        <h4 class="text-sm font-medium text-gray-300">Reescalar por Altura</h4>
                                        <div class="flex items-center space-x-2">
                                            <input type="number" id="global-max-height" value="50" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Altura M√°x.">
                                            <button id="global-apply-height-btn" class="w-1/2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-medium transition-colors">
                                                Aplicar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <h2 class="text-lg font-semibold">Partes del Modelo</h2>
                                        <button id="add-part-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-medium transition-colors">
                                            A√±adir
                                        </button>
                                    </div>
                                    <div id="part-list" class="h-40 bg-gray-800 rounded-md overflow-y-auto border border-gray-600">
                                        </div>
                                </div>

                                <div id="property-editor" class="bg-gray-700 rounded-lg p-3 flex-1 space-y-3" style="display: none;">
                                    <h3 class="text-md font-semibold text-blue-300">Editando: <span id="part-name-label"></span></h3>
                                    
                                    <div>
                                        <label for="part-shape" class="block text-sm font-medium text-gray-300">Tipo de Geometr√≠a</label>
                                        <select id="part-shape" class="w-full bg-gray-600 border border-gray-500 rounded-md px-2 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="box">Caja (Box)</option>
                                            <option value="sphere">Esfera (Sphere)</option>
                                            <option value="cylinder">Cilindro (Cylinder)</option>
                                        </select>
                                    </div>

                                    <div class="space-y-2">
                                        <h4 class="text-sm font-medium text-gray-300">Par√°metros de Geometr√≠a</h4>
                                        <div id="geometry-params-inputs" class="grid grid-cols-2 gap-2">
                                            </div>
                                    </div>

                                    <div class="space-y-2">
                                        <h4 class="text-sm font-medium text-gray-300">Posici√≥n (X, Y, Z)</h4>
                                        <div id="position-inputs" class="grid grid-cols-3 gap-2">
                                            </div>

                                        <h4 class="text-sm font-medium text-gray-300">Rotaci√≥n (RX, RY, RZ)</h4>
                                        <div id="rotation-inputs" class="grid grid-cols-3 gap-2">
                                            </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="part-color" class="block text-sm font-medium text-gray-300">Color</label>
                                            <input type="color" id="part-color" class="w-full h-10 p-0 border-none rounded-md cursor-pointer bg-gray-600">
                                        </div>
                                        <div>
                                            <label for="part-parent" class="block text-sm font-medium text-gray-300">Parent (Padre)</label>
                                            <select id="part-parent" class="w-full bg-gray-600 border border-gray-500 rounded-md px-2 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                                </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300">Textura (Asset)</label>
                                        <!-- Estructura del selector de imagen (basada en editor_fields.js) -->
                                        <div class="editor-field" data-field-id="part-texture" data-field-type="image_select">
                                            <div class="image-selector-input">
                                                <img id="part-texture-preview" alt="Preview" class="image-selector-preview" src="https://placehold.co/40x40/1f2937/4b5563?text=?">
                                                <span id="part-texture-key-display" class="image-selector-key-display">(Ninguna)</span>
                                                <button type="button" id="part-texture-select-btn" class="image-selector-button" data-action="open-image-selector">
                                                    Seleccionar...
                                                </button>
                                            </div>
                                            <input type="hidden" id="part-texture" value="">
                                        </div>
                                    </div>

                                    <button id="remove-part-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                                        Eliminar Parte
                                    </button>
                                </div>

                                <div class="bg-gray-700 rounded-lg p-3 space-y-2">
                                    <h2 class="text-lg font-semibold">Importar / Exportar</h2>
                                    <button id="export-json-btn" class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                                        Exportar a JSON
                                    </button>

 <button id="export-jsontogallery-btn" class="w-full bg-orange-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                                        Exportar a Galeria
                                    </button>

                                    <textarea id="json-io-area" class="w-full h-32 bg-gray-800 text-gray-300 text-xs font-mono rounded-md border border-gray-600 p-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Pega aqu√≠ el JSON para importar..."></textarea>
                                    <button id="import-json-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                                        Importar desde JSON
                                    </button>
                                </div>

                            </aside>

                            <main class="flex-1 h-full relative">
                                <canvas id="main-canvas" class="w-full h-full block"></canvas>
                                <div id="loading-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-20" style="display: none;">
                                    <div class="text-lg font-medium animate-pulse">Cargando Texturas...</div>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>
                </section>
        </div> 
    </div> 
    
    <div id="editor-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center flex-shrink-0">
                <h3 id="modal-title" class="text-2xl font-bold text-cyan-400">Editar Item</h3>
                <button type="button" id="modal-cancel-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>

            <div id="modal-form-content" class="modal-body space-y-4">
                </div>

            <div class="flex justify-end gap-4 flex-shrink-0 border-t border-gray-700 pt-4">
                <button type="button" id="modal-cancel-btn-2" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Cancelar
                </button>
                <button type="button" id="modal-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Aplicar Cambios
                </button>
            </div>
        </div>
    </div>

    <div id="inventory-editor-modal" class="modal-overlay">
        <div class="modal-content !max-w-5xl"> <div class="flex justify-between items-center flex-shrink-0">
                <h3 id="inventory-editor-title" class="text-2xl font-bold text-purple-400">Editor de InventARIO Inicial</h3>
                <button type="button" id="inventory-editor-cancel-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>

            <div class="modal-body">
                <p class="text-sm text-gray-400 mb-4">Define los 30 items iniciales del jugador. Haz clic en un item de la derecha para a√±adirlo al primer slot vac√≠o. Haz clic en un slot del inventario para editar la cantidad o eliminarlo.</p>
                
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-grow">
                        <h4 class="text-lg font-semibold text-gray-300 mb-2">InventARIO Inicial (30 Slots)</h4>
                        <div id="inventory-editor-grid" class="grid grid-cols-5 gap-2 p-3 bg-gray-900 rounded-md border border-gray-700">
                            </div>
                    </div>

                    <div class="w-full md:w-64 flex-shrink-0">
                        <h4 class="text-lg font-semibold text-gray-300 mb-2">Items Disponibles</h4>
                        <input type="text" id="inventory-item-filter" placeholder="Filtrar items..." class="json-value mb-2">
                        <div id="inventory-available-items" class="p-3 bg-gray-900 rounded-md border border-gray-700 max-h-[50vh] overflow-y-auto space-y-1">
                            </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-4 flex-shrink-0 border-t border-gray-700 pt-4">
                <button type="button" id="inventory-editor-cancel-btn-2" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Cancelar
                </button>
                <button type="button" id="inventory-editor-save-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Guardar InventARIO
                </button>
            </div>
        </div>
    </div>
    
    <div id="image-selector-modal" class="modal-overlay">
        <div class="modal-content !max-w-4xl"> <div class="flex justify-between items-center flex-shrink-0">
                <h3 id="image-selector-title" class="text-2xl font-bold text-cyan-400">Seleccionar Asset de Imagen</h3>
                <button type="button" id="image-selector-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>

            <div class="modal-body">
                <input type="text" id="image-selector-filter" placeholder="Filtrar por clave (ej: TREE, ROCK)..." class="json-value w-full mb-4">
                
                <div id="image-selector-grid" class="image-selector-grid max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-md border border-gray-700">
                    </div>
            </div>

            <div class="flex justify-end gap-4 flex-shrink-0 border-t border-gray-700 pt-4">
                <button type="button" id="image-selector-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    <div id="entity-selector-modal" class="modal-overlay">
        <div class="modal-content !max-w-4xl">
            <div class="flex justify-between items-center flex-shrink-0">
                <h3 id="entity-selector-title" class="text-2xl font-bold text-lime-400">Seleccionar Entidad</h3>
                <button type="button" id="entity-selector-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>

            <div class="modal-body">
                <input type="text" id="entity-selector-filter" placeholder="Filtrar por clave o nombre..." class="json-value w-full mb-4">
                
                <div id="entity-selector-grid" class="entity-selector-grid max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-md border border-gray-700">
                    </div>
            </div>

            <div class="flex justify-end gap-4 flex-shrink-0 border-t border-gray-700 pt-4">
                <button type="button" id="entity-selector-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    <div id="item-selector-modal" class="modal-overlay">
        <div class="modal-content !max-w-4xl">
            <div class="flex justify-between items-center flex-shrink-0">
                <h3 id="item-selector-title" class="text-2xl font-bold text-yellow-400">Seleccionar Item</h3>
                <button type="button" id="item-selector-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>

            <div class="modal-body">
                <input type="text" id="item-selector-filter" placeholder="Filtrar por clave o nombre..." class="json-value w-full mb-4">
                
                <div id="item-selector-grid" class="item-selector-grid max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-md border border-gray-700">
                    </div>
            </div>

            <div class="flex justify-end gap-4 flex-shrink-0 border-t border-gray-700 pt-4">
                <button type="button" id="item-selector-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    <div id="terrain-selector-modal" class="modal-overlay">
        <div class="modal-content !max-w-4xl">
            <div class="flex justify-between items-center flex-shrink-0">
                <h3 id="terrain-selector-title" class="text-2xl font-bold text-orange-400">Seleccionar Terreno</h3>
                <button type="button" id="terrain-selector-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>

            <div class="modal-body">
                <input type="text" id="terrain-selector-filter" placeholder="Filtrar por clave o nombre..." class="json-value w-full mb-4">
                
                <div id="terrain-selector-grid" class="terrain-selector-grid max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-md border border-gray-700">
                    </div>
            </div>

            <div class="flex justify-end gap-4 flex-shrink-0 border-t border-gray-700 pt-4">
                <button type="button" id="terrain-selector-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-150">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    <canvas id="resize-canvas" class="hidden"></canvas>
    
    <style>
        .gallery-container {
            padding: 1rem;
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #111827; /* bg-gray-900 */
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Responsive grid */
            gap: 1rem;
        }
        .json-editor-btn {
            font-weight: 700; /* font-bold */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            transition: all 150ms; /* transition-all duration-150 */
            color: white;
            height: 2.5rem; /* h-10 */
        }
        .tab-btn[aria-selected="true"] {
            border-color: #06b6d4; /* border-cyan-500 */
            color: #22d3ee; /* text-cyan-400 */
        }
        .tab-btn:not([aria-selected="true"]) {
            border-color: transparent;
            color: #9ca3af; /* text-gray-400 */
        }
        .tab-btn:hover:not([aria-selected="true"]) {
            color: #e5e7eb; /* text-gray-200 */
            border-color: #4b5563; /* border-gray-500 */
        }
        /* --- ¬°NUEVO! Estilo para el item de asset clickeable --- */
        .asset-grid-item:hover {
            cursor: pointer;
            outline: 2px solid #06b6d4; /* hover:ring-2 hover:ring-cyan-500 */
            outline-offset: 2px;
        }
    </style>

    <script type="module" src="jsoneditor.js"></script>
    <script type="module" src="inventory_modal.js"></script>
    <!-- ¬°NUEVO SCRIPT! -->
    <script type="module" src="gallery_3d_preview.js"></script>
    <script type="module" src="main.js"></script>
</body>
</html>